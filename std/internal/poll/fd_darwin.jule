// Copyright 2025 The Jule Programming Language.
// Use of this source code is governed by a BSD 3-Clause
// license that can be found in the LICENSE file.

use "std/sys"

impl FD {
	// Invokes SYS_FCNTL with SYS_FULLFSYNC because
	// on OS X, SYS_FSYNC doesn't fully flush contents to disk.
	// See the man page for fsync on OS X.
	fn Fsync(mut self): (ok: bool) {
		mut r := sys::Fcntl(int(self.File), sys::F_FULLFSYNC, 0)

		// There are scenarios such as SMB mounts where fcntl will fail
		// with ENOTSUP. In those cases fallback to fsync.
		if r == -1 && sys::GetLastErrno() == sys::ENOTSUP {
			r = sys::Fsync(int(self.File))
		}
		ret r != -1
	}
}