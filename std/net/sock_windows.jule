// Copyright 2024 The Jule Project Contributors. All rights reserved.
// Use of this source code is governed by a BSD 3-Clause
// license that can be found in the LICENSE file.

use "std/integ/c"
use "std/internal/poll"
use "std/internal/sys/windows"
use "std/mem"
use "std/sys"

fn lastErrorCode(): sys::Errno {
	ret sys::Errno(sys::WSAGetLastError())
}

fn syssocket(domain: int, typ: int, proto: int)!: poll::NetHandle {
	ret sys::WSASocket(domain, typ, proto, nil, 0, windows::WSA_FLAG_OVERLAPPED|windows::WSA_FLAG_NO_HANDLE_INHERIT)?
}

async fn maxListenerBacklog(): int {
	// When the socket backlog is SOMAXCONN, Windows will set the backlog to
	// "a reasonable maximum value".
	// See: https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-listen
	ret sys::SOMAXCONN
}

fn setDefaultSockopts(handle: poll::NetHandle)! {
	// On Windows, overlapped mode is non-blocking and async.
	// Created sockets use WSA_FLAG_NO_HANDLE_INHERIT,
	// which is equals to CloseOnExec on UNIX.
	// Nothing to do.
}

fn setDefaultListenerSockopts(handle: poll::NetHandle)! {
	// Windows will reuse recently-used addresses by default.
	// SO_REUSEADDR should not be used here, as it allows
	// a socket to forcibly bind to a port in use by another socket.
	// This could lead to a non-deterministic behavior, where
	// connection requests over the port cannot be guaranteed
	// to be handled by the correct socket.
}

fn init() {
	poll::InitWSA()
}